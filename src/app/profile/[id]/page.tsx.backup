'use client'

import React, { useState, useEffect, useCallback, useRef } from 'react'
import { useRouter, useParams } from 'next/navigation'
import { Card, Button, Badge, DeleteConfirmationDialog, Heading, Text, Stack, VersionBadge, StatusBadge, Container } from '@/lib/design-system/components'
import { OptimizedVideo } from '@/components/OptimizedVideo'
import { VersionCard } from '../components/VersionCard'
import { VISION_CATEGORIES, getVisionCategory, getVisionCategoryLabel, getVisionCategoryKeys, convertCategoryKey, visionToRecordingKey } from '@/lib/design-system/vision-categories'
import { UserProfile } from '@/lib/supabase/profile'
import { ProfileField } from '../components/ProfileField'
import { SavedRecordings } from '@/components/SavedRecordings'
import { ProfilePictureUpload } from '../components/ProfilePictureUpload'
import { 
  User, 
  Heart, 
  Users, 
  Activity, 
  MapPin, 
  Briefcase, 
  DollarSign,
  Edit3,
  FileText,
  ArrowLeft,
  Calendar,
  CalendarDays,
  Phone,
  Mail,
  Camera,
  Clock,
  Home,
  Building,
  GraduationCap,
  Plus,
  RefreshCw,
  Trash2,
  Eye,
  History,
  X,
  ChevronLeft,
  ChevronRight,
  Play,
  Pause,
  Plane,
  UserPlus,
  Package,
  CheckCircle2
} from 'lucide-react'
import NextImage from 'next/image'

// Helper function to get category info from design system
const getCategoryInfo = (categoryId: string) => {
  // Use centralized category mapping
  const visionCategoryKey = convertCategoryKey(categoryId, 'vision', 'vision') // If already vision key
  const category = getVisionCategory(visionCategoryKey || categoryId)
  
  if (category) {
    return {
      id: categoryId,
      title: category.label,
      icon: category.icon,
      color: 'text-primary-500',
      order: category.order,
      recordingCategory: visionToRecordingKey(categoryId)
    }
  }
  
  // Fallback for categories not in vision categories
  return {
    id: categoryId,
    title: categoryId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
    icon: User,
    color: 'text-primary-500',
    order: 999, // High number to put unmapped categories at the end
    recordingCategory: categoryId
  }
}

// Helper function to get profile categories in design system order
// Uses vision categories directly, filtering out forward/conclusion which aren't profile sections
const getOrderedProfileCategories = () => {
  const profileCategoryKeys = ['love', 'family', 'health', 'home', 'work', 'money', 'fun', 'travel', 'social', 'stuff', 'spirituality', 'giving']
  
  return profileCategoryKeys
    .map(categoryId => getCategoryInfo(categoryId))
    .sort((a, b) => a.order - b.order)
}


interface ProfileViewPageProps {}

export default function ProfileDetailPage() {
  const router = useRouter()
  const params = useParams()
  const profileId = params.id as string
  const [profile, setProfile] = useState<Partial<UserProfile>>({})
  const [completionPercentage, setCompletionPercentage] = useState(0)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [userId, setUserId] = useState<string | null>(null)
  const [versions, setVersions] = useState<any[]>([])
  const [deletingVersion, setDeletingVersion] = useState<string | null>(null)
  const [currentVersionId, setCurrentVersionId] = useState<string | null>(null)
  const [isViewingVersion, setIsViewingVersion] = useState(false)
  const [lightboxOpen, setLightboxOpen] = useState(false)
  const [lightboxIndex, setLightboxIndex] = useState(0)
  
  // Delete confirmation state
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false)
  const [versionToDelete, setVersionToDelete] = useState<any>(null)
  const [showPhotoUpload, setShowPhotoUpload] = useState(false)
  const [selectedFile, setSelectedFile] = useState<File | null>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  
  // Profile photo menu and lightbox state
  const [showPhotoMenu, setShowPhotoMenu] = useState(false)
  const [profilePhotoLightboxOpen, setProfilePhotoLightboxOpen] = useState(false)
  const [profilePhotoIndex, setProfilePhotoIndex] = useState(0)
  const photoButtonRef = useRef<HTMLButtonElement>(null)
  const photoMenuRef = useRef<HTMLDivElement>(null)
  
  // Section-level editing state
  const [editingSection, setEditingSection] = useState<string | null>(null)
  const [editedFields, setEditedFields] = useState<Record<string, any>>({})
  const [saving, setSaving] = useState(false)

  // Real-time completion calculation (matches edit page logic)
  const calculateCompletionManually = (profileData: Partial<UserProfile>): number => {
    if (!profileData) return 0

    let totalFields = 0
    let completedFields = 0

    // Helper to check if a field has value
    const hasValue = (field: keyof UserProfile) => {
      const value = profileData[field]
      if (Array.isArray(value)) return value.length > 0
      if (typeof value === 'boolean') return true
      return value !== null && value !== undefined && value !== ''
    }

    // Core Fields (always required)
    const coreFields: (keyof UserProfile)[] = ['first_name', 'last_name', 'email', 'phone', 'date_of_birth', 'gender', 'profile_picture_url']
    coreFields.forEach(field => {
      totalFields++
      if (hasValue(field)) completedFields++
    })

    // Relationship Fields (conditional)
    totalFields++
    if (hasValue('relationship_status')) {
      completedFields++
      if (profileData.relationship_status !== 'Single') {
        totalFields += 2
        if (hasValue('partner_name')) completedFields++
        if (hasValue('relationship_length')) completedFields++
      }
    }

    // Family Fields (conditional)
    totalFields++
    if (profileData.has_children !== undefined && profileData.has_children !== null) {
      completedFields++
      if (profileData.has_children === true) {
        totalFields++
        if (profileData.children && Array.isArray(profileData.children) && profileData.children.length > 0) {
          const childrenWithNames = profileData.children.filter((c: any) => c && c.first_name && c.first_name.trim().length > 0)
          if (childrenWithNames.length > 0) {
            completedFields++
          }
        }
      }
    }

    // Health, Location, Career, Financial Fields
    const healthFields: (keyof UserProfile)[] = ['units', 'height', 'weight', 'exercise_frequency']
    const locationFields: (keyof UserProfile)[] = ['living_situation', 'time_at_location', 'city', 'state', 'postal_code', 'country']
    const careerFields: (keyof UserProfile)[] = ['employment_type', 'occupation', 'company', 'time_in_role', 'education']
    const financialFields: (keyof UserProfile)[] = ['currency', 'household_income', 'savings_retirement', 'assets_equity', 'consumer_debt']

    ;[...healthFields, ...locationFields, ...careerFields, ...financialFields].forEach(field => {
      totalFields++
      if (hasValue(field)) completedFields++
    })

    // Life Category Clarity Fields (12 categories)
    const clarityFields: (keyof UserProfile)[] = [
      'clarity_fun', 'clarity_health', 'clarity_travel', 'clarity_love', 'clarity_family', 'clarity_social',
      'clarity_home', 'clarity_work', 'clarity_money', 'clarity_stuff', 'clarity_giving', 'clarity_spirituality'
    ]
    clarityFields.forEach(field => {
      totalFields++
      if (hasValue(field)) completedFields++
    })

    // Structured Life Category Fields
    const structuredFields: (keyof UserProfile)[] = [
      'hobbies', 'leisure_time_weekly',
      'travel_frequency', 'passport', 'countries_visited',
      'close_friends_count', 'social_preference',
      'lifestyle_category',
      'spiritual_practice', 'meditation_frequency', 'personal_growth_focus',
      'volunteer_status', 'charitable_giving', 'legacy_mindset'
    ]
    structuredFields.forEach(field => {
      totalFields++
      if (hasValue(field)) completedFields++
    })

    return totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0
  }

  // Recalculate completion percentage whenever profile data changes
  useEffect(() => {
    if (Object.keys(profile).length > 0) {
      const newPercentage = calculateCompletionManually(profile)
      setCompletionPercentage(newPercentage)
    }
  }, [profile])

  useEffect(() => {
    fetchProfile()
  }, [])

  // Refresh profile when page becomes visible (user navigates back)
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (!document.hidden) {
        fetchProfile()
      }
    }

    document.addEventListener('visibilitychange', handleVisibilityChange)
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange)
  }, [])

  // Load profile version based on ID parameter
  useEffect(() => {
    if (profileId) {
      setCurrentVersionId(profileId)
      fetchProfileVersion(profileId)
    }
  }, [profileId])

  // Update version viewing state when versions data is available
  useEffect(() => {
    if (!profileId) {
      setIsViewingVersion(false)
      setCurrentVersionId(null)
    } else {
      // When viewing a specific profile ID, set the version ID but allow editing
      setIsViewingVersion(false) // Allow editing on view pages
      setCurrentVersionId(profileId)
    }
  }, [profileId])

  const fetchProfile = async () => {
    try {
      // Add cache-busting parameter to force fresh data
      const timestamp = Date.now()
      const response = await fetch(`/api/profile?t=${timestamp}&includeVersions=true`)
      if (!response.ok) {
        throw new Error('Failed to fetch profile')
      }
      const data = await response.json()
      console.log('Profile view: Fetched data:', data)
      console.log('Profile view: Versions received:', data.versions?.length || 0)
      setProfile(data.profile || {})
      // Completion percentage will be calculated in real-time via useEffect
      setVersions(data.versions || [])
      
      // Get user ID from Supabase
      const { createClient } = await import('@/lib/supabase/client')
      const supabase = createClient()
      const { data: { user } } = await supabase.auth.getUser()
      if (user) {
        setUserId(user.id)
      }
    } catch (error) {
      console.error('Error fetching profile:', error)
      setError('Failed to load profile data')
    } finally {
      setLoading(false)
    }
  }

  const deleteVersion = async (versionId: string) => {
    // Note: Confirmation is handled by confirmDeleteVersion via DeleteConfirmationDialog
    // No browser confirm() needed here
    setDeletingVersion(versionId)
    try {
      const response = await fetch(`/api/profile?versionId=${versionId}`, {
        method: 'DELETE'
      })
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Failed to delete version' }))
        throw new Error(errorData.error || 'Failed to delete version')
      }

      // Refresh the profile to get updated versions list
      await fetchProfile()
    } catch (error) {
      console.error('Error deleting version:', error)
      throw error // Re-throw so confirmDeleteVersion can handle it
    } finally {
      setDeletingVersion(null)
    }
  }

  const fetchProfileVersion = async (versionId: string) => {
    setLoading(true)
    try {
      const response = await fetch(`/api/profile?versionId=${versionId}`)
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }))
        console.error('Failed to fetch profile version:', response.status, errorData)
        throw new Error(errorData.error || `Failed to fetch profile version (${response.status})`)
      }
      const data = await response.json()
      setProfile(data.profile || {})
      // Completion percentage will be calculated in real-time via useEffect
      setCurrentVersionId(versionId)
      
      // Always set as viewing version when viewing a specific ID
      setIsViewingVersion(false) // Allow editing on view pages
      
      // Also fetch versions list to get full version info
      const versionsResponse = await fetch(`/api/profile?includeVersions=true`)
      if (versionsResponse.ok) {
        const versionsData = await versionsResponse.json()
        setVersions(versionsData.versions || [])
      }
    } catch (error) {
      console.error('Error fetching profile version:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to load profile version'
      setError(errorMessage)
    } finally {
      setLoading(false)
    }
  }

  // Section-level editing functions
  const handleSectionEdit = (sectionId: string) => {
    console.log('ðŸ”§ Editing section:', sectionId)
    setEditingSection(sectionId)
    setEditedFields({}) // Reset edited fields when starting to edit a section
  }

  const handleFieldChange = async (fieldKey: string, newValue: any) => {
    setEditedFields(prev => ({
      ...prev,
      [fieldKey]: newValue
    }))
  }

  const handleSectionSave = async () => {
    if (!editingSection || Object.keys(editedFields).length === 0) return

    try {
      setSaving(true)

      // Save all edited fields at once
      const response = await fetch(`/api/profile?profileId=${profileId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(editedFields),
      })

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Failed to save' }))
        throw new Error(errorData.error || 'Failed to save')
      }

      const data = await response.json()
      
      // Update the local profile state with all saved data
      setProfile(prev => ({
        ...prev,
        ...editedFields,
      }))
      
      // Exit editing mode
      setEditingSection(null)
      setEditedFields({})
      
      console.log('Section saved successfully:', editingSection, editedFields)
    } catch (error) {
      console.error('Error saving section:', error)
      alert('Failed to save changes')
    } finally {
      setSaving(false)
    }
  }

  const handleSectionCancel = () => {
    setEditingSection(null)
    setEditedFields({})
  }

  const handleFieldSave = async (fieldKey: string, newValue: any) => {
    try {
      // Save to database via API - include profileId to update the correct profile
      const response = await fetch(`/api/profile?profileId=${profileId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          [fieldKey]: newValue
        }),
      })

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Failed to save field' }))
        throw new Error(errorData.error || 'Failed to save field')
      }

      const data = await response.json()
      
      // Update the local profile state with the saved data
      setProfile(prev => ({
        ...prev,
        [fieldKey]: newValue,
      }))
      
      // Completion percentage will be recalculated automatically via useEffect when profile updates
      
      console.log('Field saved successfully:', fieldKey, newValue)
    } catch (error) {
      console.error('Error saving field:', error)
      throw error // Re-throw so the ProfileField component can handle it
    }
  }

  // Commit draft handler - uses API endpoint
  const commitDraft = useCallback(async () => {
    try {
      const response = await fetch('/api/profile/versions', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          commitDraft: true
        }),
      })

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Failed to commit draft' }))
        throw new Error(errorData.error || 'Failed to commit draft')
      }

      // Refresh the profile to get updated versions list
      await fetchProfile()
    } catch (error) {
      console.error('Error committing draft:', error)
      alert(error instanceof Error ? error.message : 'Failed to commit draft')
    }
  }, [])

  // Delete confirmation handlers
  const handleDeleteVersion = (version: any) => {
    setVersionToDelete(version)
    setDeleteDialogOpen(true)
  }

  const confirmDeleteVersion = async () => {
    if (!versionToDelete) return
    
    try {
      await deleteVersion(versionToDelete.id)
      // Only close dialog on success
      setDeleteDialogOpen(false)
      setVersionToDelete(null)
    } catch (error) {
      console.error('Error deleting version:', error)
      // Show error message to user
      const errorMessage = error instanceof Error ? error.message : 'Failed to delete version. Please try again.'
      alert(errorMessage)
      // Keep dialog open so user can try again or cancel
    }
  }

  const formatDate = (dateString: string) => {
    if (!dateString) return 'Not specified'
    // Parse as local date to avoid timezone issues
    const [year, month, day] = dateString.split('T')[0].split('-')
    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day))
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  }

  const formatAge = (dateOfBirth: string) => {
    if (!dateOfBirth) return 'Not specified'
    // Parse as local date to avoid timezone issues
    const [year, month, day] = dateOfBirth.split('T')[0].split('-')
    const birthDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day))
    const today = new Date()
    let age = today.getFullYear() - birthDate.getFullYear()
    const monthDiff = today.getMonth() - birthDate.getMonth()
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--
    }
    return `${age} years old`
  }

  const formatPhoneNumber = (phone: string | null | undefined) => {
    if (!phone) return phone
    // Remove all non-digit characters
    const digits = phone.replace(/\D/g, '')
    // Format as (XXX) XXX-XXXX
    if (digits.length === 10) {
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`
    }
    // Return original if not 10 digits
    return phone
  }

  const formatDateOfBirth = (dateOfBirth: string | null | undefined) => {
    if (!dateOfBirth) return dateOfBirth
    // Parse date (format: YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss.sssZ)
    const dateStr = dateOfBirth.split('T')[0]
    const [year, month, day] = dateStr.split('-')
    if (year && month && day) {
      return `${month}-${day}-${year}`
    }
    return dateOfBirth
  }

  const getCompletionColor = (percentage: number) => {
    if (percentage >= 80) return 'text-green-400'
    if (percentage >= 60) return 'text-yellow-400'
    if (percentage >= 40) return 'text-orange-400'
    return 'text-red-400'
  }

  const getCompletionBg = (percentage: number) => {
    if (percentage >= 80) return 'bg-green-500'
    if (percentage >= 60) return 'bg-yellow-500'
    if (percentage >= 40) return 'bg-orange-500'
    return 'bg-red-500'
  }

  // Collect all unique profile photos from all versions
  const getAllProfilePhotos = useCallback(() => {
    const photos: string[] = []
    
    // Add current profile photo if it exists
    if (profile.profile_picture_url) {
      photos.push(profile.profile_picture_url)
    }
    
    // Add photos from all versions
    versions.forEach((version: any) => {
      if (version.profile_picture_url && !photos.includes(version.profile_picture_url)) {
        photos.push(version.profile_picture_url)
      }
    })
    
    // Remove duplicates and filter out null/undefined
    return photos.filter((url): url is string => Boolean(url))
  }, [profile.profile_picture_url, versions])

  const getCurrentVersionInfo = () => {
    if (!profileId) return null
    // Find the version info for the current profileId
    const versionInfo = versions.find(v => v.id === profileId)
    if (versionInfo) return versionInfo
    
    // If not in versions list yet, use profile data directly
    if (profile && profile.id === profileId) {
      const profileAny = profile as any
      return {
        id: profile.id,
        version_number: profileAny.version_number,
        is_draft: profileAny.is_draft,
        is_active: profileAny.is_active,
        created_at: profile.created_at,
        updated_at: profile.updated_at
      }
    }
    
    return null
  }

  const openLightbox = (index: number) => {
    setLightboxIndex(index)
    setLightboxOpen(true)
  }

  const closeLightbox = () => {
    setLightboxOpen(false)
  }

  const nextMedia = () => {
    if (profile.progress_photos) {
      setLightboxIndex((prev) => (prev + 1) % profile.progress_photos!.length)
    }
  }

  const prevMedia = () => {
    if (profile.progress_photos) {
      setLightboxIndex((prev) => (prev - 1 + profile.progress_photos!.length) % profile.progress_photos!.length)
    }
  }

  const isVideo = (url: string) => {
    return /\.(mp4|webm|quicktime)$/i.test(url) || url.includes('video/')
  }

  // Handle profile photo menu actions
  const handleSeeProfilePicture = () => {
    const allPhotos = getAllProfilePhotos()
    if (allPhotos.length > 0) {
      // Find index of current profile photo
      const currentIndex = allPhotos.findIndex(url => url === profile.profile_picture_url)
      setProfilePhotoIndex(currentIndex >= 0 ? currentIndex : 0)
      setProfilePhotoLightboxOpen(true)
    }
    setShowPhotoMenu(false)
  }

  const handleSelectProfilePicture = () => {
    setShowPhotoMenu(false)
    if (!isViewingVersion) {
      fileInputRef.current?.click()
    }
  }

  // Profile photo lightbox navigation
  const nextProfilePhoto = useCallback(() => {
    const allPhotos = getAllProfilePhotos()
    if (allPhotos.length > 0) {
      setProfilePhotoIndex((prev) => (prev + 1) % allPhotos.length)
    }
  }, [getAllProfilePhotos])

  const prevProfilePhoto = useCallback(() => {
    const allPhotos = getAllProfilePhotos()
    if (allPhotos.length > 0) {
      setProfilePhotoIndex((prev) => (prev - 1 + allPhotos.length) % allPhotos.length)
    }
  }, [getAllProfilePhotos])

  // Close menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (showPhotoMenu) {
        const target = event.target as Node
        const isClickInsideButton = photoButtonRef.current?.contains(target)
        const isClickInsideMenu = photoMenuRef.current?.contains(target)
        
        if (!isClickInsideButton && !isClickInsideMenu) {
          setShowPhotoMenu(false)
        }
      }
    }

    if (showPhotoMenu) {
      document.addEventListener('mousedown', handleClickOutside)
      return () => {
        document.removeEventListener('mousedown', handleClickOutside)
      }
    }
  }, [showPhotoMenu])

  // Keyboard navigation for profile photo lightbox
  useEffect(() => {
    if (!profilePhotoLightboxOpen) return

    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        setProfilePhotoLightboxOpen(false)
      } else if (e.key === 'ArrowLeft') {
        prevProfilePhoto()
      } else if (e.key === 'ArrowRight') {
        nextProfilePhoto()
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => {
      document.removeEventListener('keydown', handleKeyDown)
    }
  }, [profilePhotoLightboxOpen, prevProfilePhoto, nextProfilePhoto])

  // Helper function to render fields for each category
  const renderCategoryFields = (categoryId: string) => {
    switch (categoryId) {
      case 'love':
        return (
          <>
            <ProfileField 
              label="Status" 
              value={editedFields.relationship_status !== undefined ? editedFields.relationship_status : profile.relationship_status}
              editable={editingSection === 'love'}
              fieldKey="relationship_status"
              onSave={handleFieldChange}
              type="select"
              selectOptions={[
                { value: 'Single', label: 'Single' },
                { value: 'Dating', label: 'Dating' },
                { value: 'In a Relationship', label: 'In a Relationship' },
                { value: 'Engaged', label: 'Engaged' },
                { value: 'Married', label: 'Married' },
                { value: 'Separated', label: 'Separated' },
                { value: 'Divorced', label: 'Divorced' },
                { value: 'Widowed', label: 'Widowed' },
              ]}
            />
            <ProfileField 
              label="Partner" 
              value={editedFields.partner_name !== undefined ? editedFields.partner_name : profile.partner_name}
              editable={editingSection === 'love'}
              fieldKey="partner_name"
              onSave={handleFieldChange}
            />
            <ProfileField 
              label="Relationship Length" 
              value={editedFields.relationship_length !== undefined ? editedFields.relationship_length : profile.relationship_length}
              editable={editingSection === 'love'}
              fieldKey="relationship_length"
              onSave={handleFieldChange}
              type="select"
              selectOptions={[
                { value: 'Less than 1 year', label: 'Less than 1 year' },
                { value: '1-2 years', label: '1-2 years' },
                { value: '3-5 years', label: '3-5 years' },
                { value: '6-10 years', label: '6-10 years' },
                { value: '10+ years', label: '10+ years' },
              ]}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('love')}?`}
              value={editedFields.clarity_love !== undefined ? editedFields.clarity_love : profile.clarity_love}
              type="story"
              editable={editingSection === 'love'}
              fieldKey="clarity_love"
              onSave={handleFieldChange}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('love')}?`}
              value={editedFields.dream_love !== undefined ? editedFields.dream_love : profile.dream_love}
              type="story"
              editable={editingSection === 'love'}
              fieldKey="dream_love"
              onSave={handleFieldChange}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('love')}?`}
              value={editedFields.contrast_love !== undefined ? editedFields.contrast_love : profile.contrast_love}
              type="story"
              editable={editingSection === 'love'}
              fieldKey="contrast_love"
              onSave={handleFieldChange}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('love')}?`}
              value={editedFields.worry_love !== undefined ? editedFields.worry_love : profile.worry_love}
              type="story"
              editable={editingSection === 'love'}
              fieldKey="worry_love"
              onSave={handleFieldChange}
              collapsible={true}
            />
          </>
        )
      
      case 'family':
        return (
          <>
            <ProfileField 
              label="Has Children" 
              value={profile.has_children} 
              type="boolean"
              editable={false}
              fieldKey="has_children"
              onSave={handleFieldSave}
            />

            {/* Children Table */}
            {profile.children && profile.children.length > 0 && (
              <div className="space-y-2">
                <label className="block text-sm font-medium text-neutral-300">Children</label>
                <div className="bg-neutral-800/50 rounded-lg border border-neutral-700 overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-neutral-900/50 border-b border-neutral-700">
                      <tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Name</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Birthday</th>
                      </tr>
                    </thead>
                    <tbody>
                      {profile.children.map((child: any, index: number) => (
                        <tr key={index} className="border-b border-neutral-700/50 last:border-0">
                          <td className="px-4 py-2 text-sm text-white">{child.first_name || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">
                            {child.birthday ? new Date(child.birthday).toLocaleDateString() : 'Not specified'}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('family')}?`}
              value={profile.clarity_family}
              type="story"
              editable={false}
              fieldKey="clarity_family"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('family')}?`}
              value={profile.dream_family}
              type="story"
              editable={false}
              fieldKey="dream_family"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('family')}?`}
              value={profile.contrast_family}
              type="story"
              editable={false}
              fieldKey="contrast_family"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('family')}?`}
              value={profile.worry_family}
              type="story"
              editable={false}
              fieldKey="worry_family"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'health':
        return (
          <>
            <ProfileField 
              label="Height" 
              value={profile.height ? `${profile.height} ${profile.units === 'US' ? 'inches' : 'cm'}` : null}
              editable={false}
              fieldKey="height"
              onSave={handleFieldSave}
              type="number"
            />
            <ProfileField 
              label="Weight" 
              value={profile.weight ? `${profile.weight} ${profile.units === 'US' ? 'lbs' : 'kg'}` : null}
              editable={false}
              fieldKey="weight"
              onSave={handleFieldSave}
              type="number"
            />
            <ProfileField 
              label="Units" 
              value={profile.units}
              editable={false}
              fieldKey="units"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'US', label: 'US (inches, lbs)' },
                { value: 'Metric', label: 'Metric (cm, kg)' },
              ]}
            />
            <ProfileField 
              label="Exercise Frequency" 
              value={profile.exercise_frequency}
              editable={false}
              fieldKey="exercise_frequency"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Never', label: 'Never' },
                { value: '1-2 times per week', label: '1-2 times per week' },
                { value: '3-4 times per week', label: '3-4 times per week' },
                { value: '5+ times per week', label: '5+ times per week' },
                { value: 'Daily', label: 'Daily' },
              ]}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('health')}?`}
              value={profile.clarity_health}
              type="story"
              editable={false}
              fieldKey="clarity_health"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('health')}?`}
              value={profile.dream_health}
              type="story"
              editable={false}
              fieldKey="dream_health"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('health')}?`}
              value={profile.contrast_health}
              type="story"
              editable={false}
              fieldKey="contrast_health"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('health')}?`}
              value={profile.worry_health}
              type="story"
              editable={false}
              fieldKey="worry_health"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'home':
        return (
          <>
            <ProfileField 
              label="Living Situation" 
              value={profile.living_situation}
              editable={false}
              fieldKey="living_situation"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Own', label: 'Own' },
                { value: 'Rent', label: 'Rent' },
                { value: 'Living with family', label: 'Living with family' },
                { value: 'Other', label: 'Other' },
              ]}
            />
            <ProfileField 
              label="Time at Location" 
              value={profile.time_at_location}
              editable={false}
              fieldKey="time_at_location"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Less than 1 year', label: 'Less than 1 year' },
                { value: '1-2 years', label: '1-2 years' },
                { value: '3-5 years', label: '3-5 years' },
                { value: '6-10 years', label: '6-10 years' },
                { value: '10+ years', label: '10+ years' },
              ]}
            />
            <ProfileField 
              label="City" 
              value={profile.city}
              editable={false}
              fieldKey="city"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label="State" 
              value={profile.state}
              editable={false}
              fieldKey="state"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label="Postal Code" 
              value={profile.postal_code}
              editable={false}
              fieldKey="postal_code"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label="Country" 
              value={profile.country}
              editable={false}
              fieldKey="country"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('home')}?`}
              value={profile.clarity_home}
              type="story"
              editable={false}
              fieldKey="clarity_home"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('home')}?`}
              value={profile.dream_home}
              type="story"
              editable={false}
              fieldKey="dream_home"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('home')}?`}
              value={profile.contrast_home}
              type="story"
              editable={false}
              fieldKey="contrast_home"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('home')}?`}
              value={profile.worry_home}
              type="story"
              editable={false}
              fieldKey="worry_home"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'work':
        return (
          <>
            <ProfileField 
              label="Employment Type" 
              value={profile.employment_type}
              editable={false}
              fieldKey="employment_type"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Full-time', label: 'Full-time' },
                { value: 'Part-time', label: 'Part-time' },
                { value: 'Self-employed', label: 'Self-employed' },
                { value: 'Business Owner', label: 'Business Owner' },
                { value: 'Freelance', label: 'Freelance' },
                { value: 'Unemployed', label: 'Unemployed' },
                { value: 'Retired', label: 'Retired' },
                { value: 'Student', label: 'Student' },
              ]}
            />
            <ProfileField 
              label="Occupation" 
              value={profile.occupation}
              editable={false}
              fieldKey="occupation"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label="Company" 
              value={profile.company}
              editable={false}
              fieldKey="company"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label="Time in Role" 
              value={profile.time_in_role}
              editable={false}
              fieldKey="time_in_role"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Less than 1 year', label: 'Less than 1 year' },
                { value: '1-2 years', label: '1-2 years' },
                { value: '3-5 years', label: '3-5 years' },
                { value: '5-10 years', label: '5-10 years' },
                { value: '10+ years', label: '10+ years' },
              ]}
            />
            <ProfileField 
              label="Education" 
              value={profile.education}
              editable={false}
              fieldKey="education"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'High School', label: 'High School' },
                { value: 'Some College', label: 'Some College' },
                { value: 'Associate Degree', label: 'Associate Degree' },
                { value: 'Bachelor\'s Degree', label: 'Bachelor\'s Degree' },
                { value: 'Master\'s Degree', label: 'Master\'s Degree' },
                { value: 'Doctorate', label: 'Doctorate' },
                { value: 'Prefer not to say', label: 'Prefer not to say' },
              ]}
            />
            <ProfileField 
              label="Education Description" 
              value={profile.education_description}
              editable={false}
              fieldKey="education_description"
              onSave={handleFieldSave}
              type="story"
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('work')}?`}
              value={profile.clarity_work}
              type="story"
              editable={false}
              fieldKey="clarity_work"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('work')}?`}
              value={profile.dream_work}
              type="story"
              editable={false}
              fieldKey="dream_work"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('work')}?`}
              value={profile.contrast_work}
              type="story"
              editable={false}
              fieldKey="contrast_work"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('work')}?`}
              value={profile.worry_work}
              type="story"
              editable={false}
              fieldKey="worry_work"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'money':
        return (
          <>
            <ProfileField 
              label="Currency" 
              value={profile.currency}
              editable={false}
              fieldKey="currency"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'USD', label: 'USD ($)' },
                { value: 'EUR', label: 'EUR (â‚¬)' },
                { value: 'GBP', label: 'GBP (Â£)' },
                { value: 'CAD', label: 'CAD ($)' },
                { value: 'AUD', label: 'AUD ($)' },
              ]}
            />
            <ProfileField 
              label="Household Income" 
              value={profile.household_income}
              editable={false}
              fieldKey="household_income"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Under 25,000', label: 'Under $25,000' },
                { value: '25,000-49,999', label: '$25,000-$49,999' },
                { value: '50,000-74,999', label: '$50,000-$74,999' },
                { value: '75,000-99,999', label: '$75,000-$99,999' },
                { value: '100,000-249,999', label: '$100,000-$249,999' },
                { value: '250,000-499,999', label: '$250,000-$499,999' },
                { value: '500,000+', label: '$500,000+' },
              ]}
            />
            <ProfileField 
              label="Savings & Retirement" 
              value={profile.savings_retirement}
              editable={false}
              fieldKey="savings_retirement"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Under 10,000', label: 'Under $10,000' },
                { value: '10,000-24,999', label: '$10,000-$24,999' },
                { value: '25,000-49,999', label: '$25,000-$49,999' },
                { value: '50,000-99,999', label: '$50,000-$99,999' },
                { value: '100,000-249,999', label: '$100,000-$249,999' },
                { value: '250,000-499,999', label: '$250,000-$499,999' },
                { value: '500,000+', label: '$500,000+' },
              ]}
            />
            <ProfileField 
              label="Assets & Equity" 
              value={profile.assets_equity}
              editable={false}
              fieldKey="assets_equity"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'Under 10,000', label: 'Under $10,000' },
                { value: '10,000-24,999', label: '$10,000-$24,999' },
                { value: '25,000-49,999', label: '$25,000-$49,999' },
                { value: '50,000-99,999', label: '$50,000-$99,999' },
                { value: '100,000-249,999', label: '$100,000-$249,999' },
                { value: '250,000-499,999', label: '$250,000-$499,999' },
                { value: '500,000+', label: '$500,000+' },
              ]}
            />
            <ProfileField 
              label="Consumer Debt" 
              value={profile.consumer_debt}
              editable={false}
              fieldKey="consumer_debt"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'None', label: 'None' },
                { value: 'Under 10,000', label: 'Under $10,000' },
                { value: '10,000-24,999', label: '$10,000-$24,999' },
                { value: '25,000-49,999', label: '$25,000-$49,999' },
                { value: '50,000+', label: '$50,000+' },
              ]}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('money')}?`}
              value={profile.clarity_money}
              type="story"
              editable={false}
              fieldKey="clarity_money"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('money')}?`}
              value={profile.dream_money}
              type="story"
              editable={false}
              fieldKey="dream_money"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('money')}?`}
              value={profile.contrast_money}
              type="story"
              editable={false}
              fieldKey="contrast_money"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('money')}?`}
              value={profile.worry_money}
              type="story"
              editable={false}
              fieldKey="worry_money"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'fun':
        return (
          <>
            <ProfileField 
              label="Current Hobbies" 
              value={profile.hobbies} 
              type="array"
              editable={false}
              fieldKey="hobbies"
              onSave={handleFieldSave}
              placeholder="Add a hobby"
            />
            <ProfileField 
              label="Leisure Time Per Week" 
              value={profile.leisure_time_weekly}
              editable={false}
              fieldKey="leisure_time_weekly"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: '0-5 hours', label: '0-5 hours' },
                { value: '6-15 hours', label: '6-15 hours' },
                { value: '16-25 hours', label: '16-25 hours' },
                { value: '25+ hours', label: '25+ hours' },
              ]}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('fun')}?`}
              value={profile.clarity_fun}
              type="story"
              editable={false}
              fieldKey="clarity_fun"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('fun')}?`}
              value={profile.dream_fun}
              type="story"
              editable={false}
              fieldKey="dream_fun"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('fun')}?`}
              value={profile.contrast_fun}
              type="story"
              editable={false}
              fieldKey="contrast_fun"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('fun')}?`}
              value={profile.worry_fun}
              type="story"
              editable={false}
              fieldKey="worry_fun"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'travel':
        return (
          <>
            <ProfileField 
              label="Travel Frequency" 
              value={profile.travel_frequency}
              editable={false}
              fieldKey="travel_frequency"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'never', label: 'Never' },
                { value: 'yearly', label: 'Yearly' },
                { value: 'quarterly', label: 'Quarterly' },
                { value: 'monthly', label: 'Monthly' },
              ]}
            />
            <ProfileField 
              label="Has Valid Passport" 
              value={profile.passport} 
              type="boolean"
              editable={false}
              fieldKey="passport"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label="Countries Visited" 
              value={profile.countries_visited}
              type="number"
              editable={false}
              fieldKey="countries_visited"
              onSave={handleFieldSave}
            />

            {/* Trips Table */}
            {profile.trips && profile.trips.length > 0 && (
              <div className="space-y-2">
                <label className="block text-sm font-medium text-neutral-300">Trips I've Taken</label>
                <div className="bg-neutral-800/50 rounded-lg border border-neutral-700 overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-neutral-900/50 border-b border-neutral-700">
                      <tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Destination</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Year</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Duration</th>
                      </tr>
                    </thead>
                    <tbody>
                      {profile.trips.map((trip: any, index: number) => (
                        <tr key={index} className="border-b border-neutral-700/50 last:border-0">
                          <td className="px-4 py-2 text-sm text-white">{trip.destination || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">{trip.year || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">{trip.duration || 'Not specified'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('travel')}?`}
              value={profile.clarity_travel}
              type="story"
              editable={false}
              fieldKey="clarity_travel"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('travel')}?`}
              value={profile.dream_travel}
              type="story"
              editable={false}
              fieldKey="dream_travel"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('travel')}?`}
              value={profile.contrast_travel}
              type="story"
              editable={false}
              fieldKey="contrast_travel"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('travel')}?`}
              value={profile.worry_travel}
              type="story"
              editable={false}
              fieldKey="worry_travel"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'social':
        return (
          <>
            <ProfileField 
              label="Close Friends Count" 
              value={profile.close_friends_count}
              editable={false}
              fieldKey="close_friends_count"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: '0', label: '0' },
                { value: '1-3', label: '1-3' },
                { value: '4-8', label: '4-8' },
                { value: '9+', label: '9+' },
              ]}
            />
            <ProfileField 
              label="Social Preference" 
              value={profile.social_preference}
              editable={false}
              fieldKey="social_preference"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'introvert', label: 'Introvert' },
                { value: 'ambivert', label: 'Ambivert' },
                { value: 'extrovert', label: 'Extrovert' },
              ]}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('social')}?`}
              value={profile.clarity_social}
              type="story"
              editable={false}
              fieldKey="clarity_social"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('social')}?`}
              value={profile.dream_social}
              type="story"
              editable={false}
              fieldKey="dream_social"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('social')}?`}
              value={profile.contrast_social}
              type="story"
              editable={false}
              fieldKey="contrast_social"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('social')}?`}
              value={profile.worry_social}
              type="story"
              editable={false}
              fieldKey="worry_social"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'stuff':
        return (
          <>
            <ProfileField 
              label="Lifestyle Category" 
              value={profile.lifestyle_category}
              editable={false}
              fieldKey="lifestyle_category"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'minimalist', label: 'Minimalist' },
                { value: 'moderate', label: 'Moderate' },
                { value: 'comfortable', label: 'Comfortable' },
                { value: 'luxury', label: 'Luxury' },
              ]}
            />

            {/* Vehicles Table */}
            {profile.vehicles && profile.vehicles.length > 0 && (
              <div className="space-y-2">
                <label className="block text-sm font-medium text-neutral-300">Vehicles</label>
                <div className="bg-neutral-800/50 rounded-lg border border-neutral-700 overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-neutral-900/50 border-b border-neutral-700">
                      <tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Vehicle Name</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Year Acquired</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Ownership Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {profile.vehicles.map((vehicle: any, index: number) => (
                        <tr key={index} className="border-b border-neutral-700/50 last:border-0">
                          <td className="px-4 py-2 text-sm text-white">{vehicle.name || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">{vehicle.year_acquired || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">
                            {vehicle.ownership_status === 'paid_in_full' && 'Paid In Full'}
                            {vehicle.ownership_status === 'own_with_payment' && 'Own with a payment'}
                            {vehicle.ownership_status === 'leased' && 'Leased'}
                            {vehicle.ownership_status === 'borrowed' && 'Borrowed'}
                            {!vehicle.ownership_status && 'Not specified'}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Toys Table */}
            {profile.toys && profile.toys.length > 0 && (
              <div className="space-y-2">
                <label className="block text-sm font-medium text-neutral-300">Toys</label>
                <div className="bg-neutral-800/50 rounded-lg border border-neutral-700 overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-neutral-900/50 border-b border-neutral-700">
                      <tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Item Name</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Year Acquired</th>
                        <th className="px-4 py-2 text-left text-xs font-medium text-neutral-400">Ownership Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {profile.toys.map((toy: any, index: number) => (
                        <tr key={index} className="border-b border-neutral-700/50 last:border-0">
                          <td className="px-4 py-2 text-sm text-white">{toy.name || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">{toy.year_acquired || 'Not specified'}</td>
                          <td className="px-4 py-2 text-sm text-neutral-300">
                            {toy.ownership_status === 'paid_in_full' && 'Paid In Full'}
                            {toy.ownership_status === 'own_with_payment' && 'Own with a payment'}
                            {toy.ownership_status === 'leased' && 'Leased'}
                            {toy.ownership_status === 'borrowed' && 'Borrowed'}
                            {!toy.ownership_status && 'Not specified'}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('stuff')}?`}
              value={profile.clarity_stuff}
              type="story"
              editable={false}
              fieldKey="clarity_stuff"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('stuff')}?`}
              value={profile.dream_stuff}
              type="story"
              editable={false}
              fieldKey="dream_stuff"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('stuff')}?`}
              value={profile.contrast_stuff}
              type="story"
              editable={false}
              fieldKey="contrast_stuff"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('stuff')}?`}
              value={profile.worry_stuff}
              type="story"
              editable={false}
              fieldKey="worry_stuff"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'spirituality':
        return (
          <>
            <ProfileField 
              label="Spiritual Practice" 
              value={profile.spiritual_practice}
              editable={false}
              fieldKey="spiritual_practice"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'none', label: 'None' },
                { value: 'religious', label: 'Religious' },
                { value: 'spiritual', label: 'Spiritual' },
                { value: 'secular', label: 'Secular' },
              ]}
            />
            <ProfileField 
              label="Meditation Frequency" 
              value={profile.meditation_frequency}
              editable={false}
              fieldKey="meditation_frequency"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'never', label: 'Never' },
                { value: 'rarely', label: 'Rarely' },
                { value: 'weekly', label: 'Weekly' },
                { value: 'daily', label: 'Daily' },
              ]}
            />
            <ProfileField 
              label="Personal Growth Focus" 
              value={profile.personal_growth_focus} 
              type="boolean"
              editable={false}
              fieldKey="personal_growth_focus"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('spirituality')}?`}
              value={profile.clarity_spirituality}
              type="story"
              editable={false}
              fieldKey="clarity_spirituality"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('spirituality')}?`}
              value={profile.dream_spirituality}
              type="story"
              editable={false}
              fieldKey="dream_spirituality"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('spirituality')}?`}
              value={profile.contrast_spirituality}
              type="story"
              editable={false}
              fieldKey="contrast_spirituality"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('spirituality')}?`}
              value={profile.worry_spirituality}
              type="story"
              editable={false}
              fieldKey="worry_spirituality"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      case 'giving':
        return (
          <>
            <ProfileField 
              label="Volunteer Status" 
              value={profile.volunteer_status}
              editable={false}
              fieldKey="volunteer_status"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'none', label: 'None' },
                { value: 'occasional', label: 'Occasional' },
                { value: 'regular', label: 'Regular' },
                { value: 'frequent', label: 'Frequent' },
              ]}
            />
            <ProfileField 
              label="Annual Charitable Giving" 
              value={profile.charitable_giving}
              editable={false}
              fieldKey="charitable_giving"
              onSave={handleFieldSave}
              type="select"
              selectOptions={[
                { value: 'none', label: 'None' },
                { value: '<500', label: 'Under $500' },
                { value: '500-2000', label: '$500-$2,000' },
                { value: '2000+', label: '$2,000+' },
              ]}
            />
            <ProfileField 
              label="Legacy Mindset" 
              value={profile.legacy_mindset} 
              type="boolean"
              editable={false}
              fieldKey="legacy_mindset"
              onSave={handleFieldSave}
            />
            <ProfileField 
              label={`What's going well in ${getVisionCategoryLabel('giving')}?`}
              value={profile.clarity_giving}
              type="story"
              editable={false}
              fieldKey="clarity_giving"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you dream about in ${getVisionCategoryLabel('giving')}?`}
              value={profile.dream_giving}
              type="story"
              editable={false}
              fieldKey="dream_giving"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What's not going well in ${getVisionCategoryLabel('giving')}?`}
              value={profile.contrast_giving}
              type="story"
              editable={false}
              fieldKey="contrast_giving"
              onSave={handleFieldSave}
              collapsible={true}
            />
            <ProfileField 
              label={`What do you worry about in ${getVisionCategoryLabel('giving')}?`}
              value={profile.worry_giving}
              type="story"
              editable={false}
              fieldKey="worry_giving"
              onSave={handleFieldSave}
              collapsible={true}
            />
          </>
        )
      
      default:
        return null
    }
  }

  // Keyboard navigation for lightbox
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!lightboxOpen) return
      
      switch (e.key) {
        case 'Escape':
          closeLightbox()
          break
        case 'ArrowLeft':
          prevMedia()
          break
        case 'ArrowRight':
          nextMedia()
          break
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [lightboxOpen])

  if (loading) {
    return (
      <>
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
            <p className="text-neutral-400">Loading your profile...</p>
          </div>
        </div>
      </>
    )
  }

  if (error) {
    return (
      <>
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <div className="text-red-500 mb-4">
              <User className="w-16 h-16 mx-auto" />
            </div>
            <h2 className="text-2xl font-bold text-white mb-2">Profile Error</h2>
            <p className="text-neutral-400 mb-6">{error}</p>
            <Button onClick={fetchProfile} variant="primary">
              Try Again
            </Button>
          </div>
        </div>
      </>
    )
  }

  const versionInfo = getCurrentVersionInfo()
  const displayStatus = versionInfo?.is_active && !versionInfo?.is_draft ? 'active' : versionInfo?.is_draft ? 'draft' : 'complete'

  if (!profile || Object.keys(profile).length === 0) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
          <p className="text-neutral-400">Loading your profile...</p>
        </div>
      </div>
    )
  }

  return (
    <>
        {/* Page Hero */}
        <div className="mb-8">
          {/* Subtle Gradient Background */}
          <div className="relative p-[2px] rounded-2xl bg-gradient-to-br from-[#39FF14]/30 via-[#14B8A6]/20 to-[#BF00FF]/30">
            {/* Modern Enhanced Layout with Card Container */}
            <div className="relative p-4 md:p-6 lg:p-8 rounded-2xl bg-gradient-to-br from-[#39FF14]/10 via-[#14B8A6]/5 to-transparent shadow-[0_8px_32px_rgba(0,0,0,0.4)]">
              
              <div className="relative z-10">
                {/* Profile Picture */}
                <div className="text-center mb-4 relative">
                  <button
                    ref={photoButtonRef}
                    onClick={() => {
                      if (!isViewingVersion) {
                        setShowPhotoMenu(!showPhotoMenu)
                      }
                    }}
                    disabled={isViewingVersion}
                    className="inline-block relative group"
                  >
                    {profile.profile_picture_url ? (
                      <div className="inline-block w-24 h-24 md:w-32 md:h-32 rounded-full overflow-hidden bg-neutral-800 border-2 border-white relative">
                        <NextImage
                          src={profile.profile_picture_url}
                          alt="Profile picture"
                          width={128}
                          height={128}
                          className="w-full h-full object-cover"
                        />
                        {!isViewingVersion && (
                          <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-full">
                            <Camera className="w-6 h-6 md:w-8 md:h-8 text-white" />
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="inline-block w-24 h-24 md:w-32 md:h-32 rounded-full bg-gradient-to-br from-primary-500 to-primary-600 border-2 border-white flex items-center justify-center">
                        <Camera className="w-8 h-8 md:w-12 md:h-12 text-white" />
                      </div>
                    )}
                  </button>
                  {/* Hidden file input */}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/jpeg,image/jpg,image/png,image/webp"
                    onChange={(e) => {
                      const file = e.target.files?.[0]
                      if (file) {
                        setSelectedFile(file)
                        setShowPhotoUpload(true)
                      }
                    }}
                    className="hidden"
                  />
                  
                  {/* Profile Photo Menu */}
                  {showPhotoMenu && !isViewingVersion && (
                    <div 
                      ref={photoMenuRef}
                      className="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 z-50"
                      onClick={(e) => e.stopPropagation()}
                    >
                      {/* Caret pointing up to photo */}
                      <div className="absolute -top-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-white"></div>
                      <div className="absolute -top-[9px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[5px] border-r-[5px] border-b-[5px] border-transparent border-b-white"></div>
                      <Card className="!p-1 min-w-[240px] md:min-w-[200px] shadow-xl relative !border !border-white !bg-white">
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            handleSeeProfilePicture()
                          }}
                          className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-neutral-100 transition-colors text-left"
                        >
                          <Eye className="w-4 h-4 text-[#1F1F1F]" />
                          <span className="text-[#1F1F1F] text-sm">See profile picture</span>
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            handleSelectProfilePicture()
                          }}
                          className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-neutral-100 transition-colors text-left"
                        >
                          <Camera className="w-4 h-4 text-[#1F1F1F]" />
                          <span className="text-[#1F1F1F] text-sm">Update profile picture</span>
                        </button>
                      </Card>
                    </div>
                  )}
                </div>

                {/* Title Section */}
                <div className="text-center mb-4">
                  <h1 className="text-2xl md:text-5xl font-bold leading-tight text-white">
                    {profile.first_name && profile.last_name
                      ? `${profile.first_name} ${profile.last_name}`
                      : 'My Profile'}
                  </h1>
                </div>

                {/* Centered Version Info with Enhanced Styling */}
                {versionInfo && (
                  <div className="text-center mb-6">
                    {/* Version, Status & Date Badges */}
                    <div className="inline-flex flex-wrap items-center justify-center gap-2 md:gap-3 px-3 md:px-4 py-2 md:py-3 rounded-2xl bg-neutral-900/60 border border-neutral-700/50 backdrop-blur-sm">
                      <VersionBadge 
                        versionNumber={versionInfo.version_number} 
                        status={displayStatus} 
                      />
                      <StatusBadge 
                        status={displayStatus} 
                        subtle={displayStatus !== 'active'}
                        className="uppercase tracking-[0.25em]"
                      />
                      <div className="flex items-center gap-1.5 text-neutral-300 text-xs md:text-sm">
                        <CalendarDays className="w-4 h-4 text-neutral-500" />
                        <span className="font-medium">Created:</span>
                        <span>{new Date(versionInfo.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                      </div>
                      {/* Profile Completion Percentage */}
                      <span className="text-xs md:text-sm font-semibold text-[#39FF14]">
                        {completionPercentage}%
                      </span>
                    </div>
                  </div>
                )}

                {/* Action Buttons - Enhanced with Hover Effects */}
                <div className="flex flex-row flex-wrap md:flex-nowrap gap-2 md:gap-4 max-w-2xl mx-auto">
                  <Button
                    onClick={() => router.push('/profile')}
                    variant="outline"
                    size="sm"
                    className="flex-1 flex items-center justify-center gap-1 md:gap-2 hover:-translate-y-0.5 transition-all duration-300 text-xs md:text-sm"
                  >
                    <Eye className="w-4 h-4 shrink-0" />
                    <span>See All Profiles</span>
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Main Content */}
        <Container size="xl">
        {/* Quick Stats */}
        <div className="space-y-4 mb-8">
            
            <Card className="p-6 h-full">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                  <User className="w-5 h-5 text-primary-500" />
                  Personal Information
                </h3>
                {editingSection !== 'personal' ? (
                  <Button
                    onClick={() => handleSectionEdit('personal')}
                    variant="outline"
                    size="sm"
                    className="!p-2 !aspect-square md:!aspect-auto md:!px-4 md:!py-3"
                  >
                    <Edit3 className="w-4 h-4" />
                    <span className="hidden md:inline">Edit</span>
                  </Button>
                ) : (
                  <div className="flex gap-2">
                    <Button
                      onClick={handleSectionCancel}
                      variant="outline"
                      size="sm"
                      disabled={saving}
                    >
                      Cancel
                    </Button>
                    <Button
                      onClick={handleSectionSave}
                      variant="primary"
                      size="sm"
                      disabled={saving || Object.keys(editedFields).length === 0}
                    >
                      {saving ? 'Saving...' : 'Save'}
                    </Button>
                  </div>
                )}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {console.log('ðŸŽ¯ Personal section - editingSection:', editingSection, 'editable:', editingSection === 'personal')}
                <ProfileField
                  label="Email"
                  value={editedFields.email !== undefined ? editedFields.email : profile.email}
                  editable={editingSection === 'personal'}
                  fieldKey="email"
                  onSave={handleFieldChange}
                  type="text"
                />
                <ProfileField
                  label="Date of Birth"
                  value={editedFields.date_of_birth !== undefined ? formatDateOfBirth(editedFields.date_of_birth) : formatDateOfBirth(profile.date_of_birth)}
                  editable={editingSection === 'personal'}
                  fieldKey="date_of_birth"
                  onSave={handleFieldChange}
                  type="text"
                />
                <div className="flex items-center gap-3">
                  <div>
                    <p className="text-sm text-neutral-400">Age</p>
                    <p className="text-white font-medium">
                      {profile.date_of_birth ? formatAge(profile.date_of_birth) : 'Not specified'}
                    </p>
                  </div>
                </div>
                <ProfileField
                  label="Gender"
                  value={editedFields.gender !== undefined ? editedFields.gender : profile.gender}
                  editable={editingSection === 'personal'}
                  fieldKey="gender"
                  onSave={handleFieldChange}
                  type="select"
                  selectOptions={[
                    { value: 'Male', label: 'Male' },
                    { value: 'Female', label: 'Female' },
                    { value: 'Prefer not to say', label: 'Prefer not to say' },
                  ]}
                />
                <ProfileField
                  label="Phone"
                  value={editedFields.phone !== undefined ? formatPhoneNumber(editedFields.phone) : formatPhoneNumber(profile.phone)}
                  editable={editingSection === 'personal'}
                  fieldKey="phone"
                  onSave={handleFieldChange}
                  type="text"
                />
                <ProfileField
                  label="Ethnicity"
                  value={editedFields.ethnicity !== undefined ? editedFields.ethnicity : profile.ethnicity}
                  editable={editingSection === 'personal'}
                  fieldKey="ethnicity"
                  onSave={handleFieldChange}
                  type="select"
                  selectOptions={[
                    { value: 'Asian', label: 'Asian' },
                    { value: 'Black', label: 'Black' },
                    { value: 'Hispanic', label: 'Hispanic' },
                    { value: 'Middle Eastern', label: 'Middle Eastern' },
                    { value: 'Multi-ethnic', label: 'Multi-ethnic' },
                    { value: 'Native American', label: 'Native American' },
                    { value: 'Pacific Islander', label: 'Pacific Islander' },
                    { value: 'White', label: 'White' },
                    { value: 'Other', label: 'Other' },
                    { value: 'Prefer not to say', label: 'Prefer not to say' },
                  ]}
                />
              </div>
            </Card>
        </div>

        {/* Detailed Sections */}
        {/* Media */}
        {profile.progress_photos && profile.progress_photos.length > 0 && (
          <div className="mb-8">
            <Card className="p-6">
              <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                <Camera className="w-5 h-5 text-primary-500" />
                Media
              </h3>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {profile.progress_photos.map((media, index) => (
                  <div key={index} className="relative group">
                    {isVideo(media) ? (
                      <div className="relative" onClick={() => openLightbox(index)}>
                        <OptimizedVideo
                          url={media}
                          context="list"
                          lazy={true}
                          className="w-full aspect-[4/3] rounded-lg"
                        />
                      </div>
                    ) : (
                      <img
                        src={media}
                        alt={`Media ${index + 1}`}
                        className="w-full aspect-[4/3] object-cover rounded-lg border border-neutral-700 hover:border-primary-500 transition-colors cursor-pointer"
                        onClick={() => openLightbox(index)}
                      />
                    )}
                  </div>
                ))}
              </div>
              <p className="text-sm text-neutral-400 mt-3">
                {profile.progress_photos.length} media file{profile.progress_photos.length !== 1 ? 's' : ''} â€¢ Click to view in lightbox
              </p>
            </Card>
          </div>
        )}

        {/* Life Category Cards - Ordered by Design System */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {getOrderedProfileCategories().map((category) => {
            const IconComponent = category.icon
            
            return (
              <Card key={category.id} className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                    <IconComponent className="w-5 h-5 text-primary-500" />
                    {category.title}
                  </h3>
                  {editingSection !== category.id ? (
                    <Button
                      onClick={() => handleSectionEdit(category.id)}
                      variant="outline"
                      size="sm"
                      className="!p-2 !aspect-square md:!aspect-auto md:!px-4 md:!py-3"
                    >
                      <Edit3 className="w-4 h-4" />
                      <span className="hidden md:inline">Edit</span>
                    </Button>
                  ) : (
                    <div className="flex gap-2">
                      <Button
                        onClick={handleSectionCancel}
                        variant="outline"
                        size="sm"
                        disabled={saving}
                      >
                        Cancel
                      </Button>
                      <Button
                        onClick={handleSectionSave}
                        variant="primary"
                        size="sm"
                        disabled={saving || Object.keys(editedFields).length === 0}
                      >
                        {saving ? 'Saving...' : 'Save'}
                      </Button>
                    </div>
                  )}
                </div>
                <div className="space-y-3">
                  {renderCategoryFields(category.id)}
                  
                  {/* Saved Recordings */}
                  <SavedRecordings
                    recordings={profile.story_recordings || []}
                    categoryFilter={category.recordingCategory}
                  />
                </div>
              </Card>
            )
          })}
        </div>

        {/* Delete Button */}
        <div className="mt-8 pt-6 border-t border-neutral-800 text-center">
          <Button
            onClick={() => {
              const currentVersion = getCurrentVersionInfo()
              if (currentVersion) {
                handleDeleteVersion(currentVersion)
              } else if (versions.length > 0) {
                handleDeleteVersion(versions[0])
              }
            }}
            variant="danger"
            size="sm"
            className="flex items-center gap-2 mx-auto"
            disabled={deletingVersion !== null}
          >
            {deletingVersion ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                Deleting...
              </>
            ) : (
              <>
                <Trash2 className="w-4 h-4" />
                Delete Version
              </>
            )}
          </Button>
        </div>

      {/* Lightbox */}
      {lightboxOpen && profile.progress_photos && (
        <div 
          className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center"
          onClick={closeLightbox}
        >
          <div 
            className="relative w-full h-full flex items-center justify-center p-4"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Close Button */}
            <button
              onClick={closeLightbox}
              className="absolute top-4 right-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
            >
              <X className="w-6 h-6" />
            </button>

            {/* Navigation Buttons */}
            {profile.progress_photos.length > 1 && (
              <>
                <button
                  onClick={prevMedia}
                  className="absolute left-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
                <button
                  onClick={nextMedia}
                  className="absolute right-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              </>
            )}

            {/* Media Content */}
            <div className="max-w-4xl max-h-full w-full h-full flex items-center justify-center">
              {isVideo(profile.progress_photos[lightboxIndex]) ? (
                <video
                  src={profile.progress_photos[lightboxIndex]}
                  controls
                  autoPlay
                  className="max-w-full max-h-full object-contain"
                />
              ) : (
                <img
                  src={profile.progress_photos[lightboxIndex]}
                  alt={`Media ${lightboxIndex + 1}`}
                  className="max-w-full max-h-full object-contain"
                />
              )}
            </div>

            {/* Media Counter */}
            {profile.progress_photos.length > 1 && (
              <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-3 py-1 rounded-full text-sm">
                {lightboxIndex + 1} of {profile.progress_photos.length}
              </div>
            )}

            {/* Thumbnail Strip */}
            {profile.progress_photos.length > 1 && (
              <div className="absolute bottom-16 left-1/2 transform -translate-x-1/2 flex gap-2 max-w-full overflow-x-auto px-4">
                {profile.progress_photos.map((media, index) => (
                  <button
                    key={index}
                    onClick={() => setLightboxIndex(index)}
                    className={`flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition-colors ${
                      index === lightboxIndex ? 'border-primary-500' : 'border-neutral-600'
                    }`}
                  >
                    {isVideo(media) ? (
                      <div className="relative w-full h-full">
                        <video
                          src={media}
                          className="w-full h-full object-cover"
                        />
                        <div className="absolute inset-0 flex items-center justify-center bg-black/20">
                          <Play className="w-4 h-4 text-white" />
                        </div>
                      </div>
                    ) : (
                      <img
                        src={media}
                        alt={`Thumbnail ${index + 1}`}
                        className="w-full h-full object-cover"
                      />
                    )}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Profile Photo Lightbox */}
      {profilePhotoLightboxOpen && (() => {
        const allPhotos = getAllProfilePhotos()
        if (allPhotos.length === 0) return null
        
        return (
          <div 
            className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center"
            onClick={() => setProfilePhotoLightboxOpen(false)}
          >
            <div 
              className="relative w-full h-full flex items-center justify-center p-4"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Close Button */}
              <button
                onClick={() => setProfilePhotoLightboxOpen(false)}
                className="absolute top-4 right-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
              >
                <X className="w-6 h-6" />
              </button>

              {/* Navigation Buttons */}
              {allPhotos.length > 1 && (
                <>
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      prevProfilePhoto()
                    }}
                    className="absolute left-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
                  >
                    <ChevronLeft className="w-6 h-6" />
                  </button>
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      nextProfilePhoto()
                    }}
                    className="absolute right-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70 transition-colors"
                  >
                    <ChevronRight className="w-6 h-6" />
                  </button>
                </>
              )}

              {/* Photo Content */}
              <div className="max-w-6xl max-h-full w-full h-full flex items-center justify-center">
                <img
                  src={allPhotos[profilePhotoIndex]}
                  alt={`Profile photo ${profilePhotoIndex + 1}`}
                  className="max-w-full max-h-[90vh] object-contain rounded-lg"
                />
              </div>

              {/* Photo Counter */}
              {allPhotos.length > 1 && (
                <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-3 py-1 rounded-full text-sm">
                  {profilePhotoIndex + 1} of {allPhotos.length}
                </div>
              )}

              {/* Thumbnail Strip */}
              {allPhotos.length > 1 && (
                <div className="absolute bottom-16 left-1/2 transform -translate-x-1/2 flex gap-2 max-w-full overflow-x-auto px-4">
                  {allPhotos.map((photo, index) => (
                    <button
                      key={index}
                      onClick={(e) => {
                        e.stopPropagation()
                        setProfilePhotoIndex(index)
                      }}
                      className={`flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition-colors ${
                        index === profilePhotoIndex ? 'border-primary-500' : 'border-neutral-600'
                      }`}
                    >
                      <img
                        src={photo}
                        alt={`Thumbnail ${index + 1}`}
                        className="w-full h-full object-cover"
                      />
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        )
      })()}
        </Container>

      {/* Delete Confirmation Dialog */}
      <DeleteConfirmationDialog
        isOpen={deleteDialogOpen}
        onClose={() => {
          setDeleteDialogOpen(false)
          setVersionToDelete(null)
        }}
        onConfirm={confirmDeleteVersion}
        itemName={`Version ${versionToDelete?.version_number || ''}`}
        itemType="profile version"
        isLoading={deletingVersion === versionToDelete?.id}
        loadingText="Deleting version..."
      />
    </>
  )
}
