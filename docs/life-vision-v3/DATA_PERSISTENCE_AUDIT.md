# Life Vision V3 - Data Persistence Audit

**Date:** November 11, 2025  
**Purpose:** Document what data is being stored at each step and identify gaps for fine-tuning

---

## üìä STORAGE STATUS BY STEP

### ‚úÖ Step 1: Clarity from Current State (STORED)
**Page:** `/life-vision/new/category/[key]`  
**API:** `/api/viva/category-summary`

**What's Stored:**
- ‚úÖ `refinements.ai_summary` - Category summary generated by VIVA
- ‚úÖ `frequency_flip.*` - All flipped contrast statements
  - `input_text` (original contrast)
  - `clarity_seed` (flipped version)
  - `essence`, `sensory_anchor`, `embodiment_line`, `surrender_line`
  - `mode`, `unchanged`, `voice_notes`
  - `category`, `user_id`, `created_at`

**Token Tracking:** ‚úÖ Yes  
**Action Types:** `frequency_flip`, `life_vision_category_summary`

---

### ‚ùå Step 2: Unleash Imagination (NOT STORED)
**Page:** `/life-vision/new/category/[key]/imagination`  
**API:** `/api/viva/ideal-state`

**What's Generated but NOT STORED:**
- ‚ùå Generated prompts array (5 prompts per category)
  - `title` - Prompt question
  - `prompt` - Full prompt text  
  - `focus` - Focus area (sensory, embodiment, etc.)
- ‚ùå `encouragement` - VIVA's encouragement message

**What IS Stored:**
- ‚úÖ `refinements.ideal_state` - User's combined answers to prompts

**Gap Identified:**
- **Missing:** The AI-generated prompts themselves
- **Why it matters:** For fine-tuning prompt generation quality
- **Recommendation:** Create `ideal_state_prompts` table

**Token Tracking:** ‚úÖ Yes  
**Action Type:** `vision_generation` (temp - should be `ideal_state_generation`)

---

### ‚úÖ Step 3: Blueprint Generation (STORED)
**Page:** `/life-vision/new/category/[key]/blueprint`  
**API:** `/api/viva/blueprint`

**What's Stored:**
- ‚úÖ `refinements.blueprint_data` (JSONB array)
  ```json
  [
    {
      "being": "Who I am in this area",
      "doing": "What I do/actions I take",
      "receiving": "What flows to me as a result",
      "essence": "Core essence word"
    }
  ]
  ```
- ‚úÖ Multiple loops per category supported
- ‚úÖ User edits persisted

**Token Tracking:** ‚úÖ Yes  
**Action Type:** `blueprint_generation` ‚úÖ (already exists!)

---

### ‚úÖ Step 4: Scene Generation (STORED)
**Page:** `/life-vision/new/category/[key]/scenes`  
**API:** `/api/vibration/scenes/generate`  
**Service:** `src/lib/vibration/service.ts`

**What's Stored:**
- ‚úÖ `scenes.*` - Complete scene data
  - `user_id`, `category`, `title`, `text`
  - `essence_word`, `emotional_valence`
  - `created_at`, `version`
- ‚úÖ `vibrational_events.*` - Associated vibrational analysis
  - `source_type: 'scene'`
  - `emotional_valence`, `dominant_emotions`, `intensity`
  - `essence_word`, `summary_in_their_voice`

**V3 Enhancements Tracked:**
- ‚úÖ Dynamic scene count recommendations in token metadata
- ‚úÖ Data richness tier stored

**Token Tracking:** ‚úÖ Yes  
**Action Type:** `scene_generation`

---

### ‚ö†Ô∏è Step 5: Master Assembly (PARTIAL STORAGE)
**Page:** `/life-vision/new/assembly`  
**API:** `/api/viva/master-vision`

**What's Stored:**
- ‚úÖ `vision_versions.full_text` - Complete assembled vision (markdown)
- ‚úÖ `vision_versions.json_data` - Parsed category sections (JSONB)
- ‚úÖ `vision_versions.richness_metadata` (V3) - Per-category richness data (JSONB)
  ```json
  {
    "fun": {
      "inputChars": 1234,
      "ideas": 8,
      "density": "high",
      "targetMinChars": 1111,
      "targetMaxChars": 1357
    }
  }
  ```
- ‚úÖ `vision_versions.status: 'draft'` - Initial status

**What's NOT Stored:**
- ‚ùå The raw category transcripts used as input
- ‚ùå The specific prompt used for assembly
- ‚ùå Individual category sections as separate records

**Token Tracking:** ‚úÖ Yes  
**Action Type:** `life_vision_master_assembly`

---

### ‚úÖ Step 6: Final Polish & Activation (STORED)
**Page:** `/life-vision/new/final`  
**API:** `/api/viva/final-assembly`

**What's Stored:**
- ‚úÖ `vision_versions.forward` - Opening section
- ‚úÖ `vision_versions.conclusion` - Closing section
- ‚úÖ `vision_versions.activation_message` (V3) - Celebration & next steps
- ‚úÖ Updated `updated_at` timestamp

**What's Generated but NOT STORED:**
- ‚ùå `harmonizationNotes` - AI's notes on vision coherence
- ‚ùå `suggestedActions` - Individual action suggestions (only stored in activation_message as text)

**Token Tracking:** ‚úÖ Yes  
**Action Types:** `vision_generation` (temp - should be `final_assembly`, `activation_message`)

---

## üéØ SUMMARY: What's Missing

### Critical Gaps (Recommend Adding)

1. **Ideal State Prompts Table** ‚ùå HIGH PRIORITY
   ```sql
   CREATE TABLE ideal_state_prompts (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
     category TEXT NOT NULL,
     prompts JSONB NOT NULL, -- Array of {title, prompt, focus}
     encouragement TEXT,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     model_used TEXT,
     tokens_used INTEGER,
     UNIQUE(user_id, category, created_at DESC)
   );
   ```

2. **Master Assembly Input Snapshots** ‚ùå MEDIUM PRIORITY
   ```sql
   CREATE TABLE vision_assembly_snapshots (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     vision_id UUID NOT NULL REFERENCES vision_versions(id) ON DELETE CASCADE,
     category_transcripts JSONB, -- Raw input per category
     category_summaries JSONB, -- Summaries used
     richness_computed JSONB, -- Richness metadata at assembly time
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   ```

3. **Harmonization Notes** ‚ùå LOW PRIORITY
   ```sql
   ALTER TABLE vision_versions
     ADD COLUMN harmonization_notes JSONB;
   ```

### Minor Improvements

4. **Action Type Specificity** ‚ö†Ô∏è
   - Currently using temp action types:
     - `ideal_state_generation` ‚Üí using `vision_generation`
     - `final_assembly` ‚Üí using `vision_generation`
     - `activation_message` ‚Üí using `vision_generation`
   - **Recommendation:** Add these specific types to token tracking enum

---

## üìà FINE-TUNING DATA AVAILABILITY

### What You CAN Fine-Tune With Current Data:

‚úÖ **Frequency Flip Quality**
- Input: `frequency_flip.input_text`
- Output: `frequency_flip.clarity_seed`
- Context: `category`, `voice_notes`

‚úÖ **Category Summary Quality**
- Input: Category transcripts (from user input)
- Output: `refinements.ai_summary`
- Metadata: Token usage, timing

‚úÖ **Blueprint Generation Quality**
- Input: `refinements.ideal_state`, `refinements.ai_summary`
- Output: `refinements.blueprint_data`
- Edits: Track user edits to blueprint loops

‚úÖ **Scene Generation Quality**
- Input: Profile data, assessment, existing vision
- Output: `scenes.text`, `scenes.title`
- Validation: `scenes.essence_word`, `vibrational_events.*`

‚úÖ **Master Vision Assembly**
- Input: Per-category summaries
- Output: `vision_versions.full_text`, `vision_versions.json_data`
- Quality: `vision_versions.richness_metadata` (V3!)

‚úÖ **Forward/Conclusion Polish**
- Input: Assembled vision
- Output: `vision_versions.forward`, `vision_versions.conclusion`

### What You CANNOT Fine-Tune Without New Storage:

‚ùå **Ideal State Prompt Generation**
- Problem: Prompts are generated but not saved
- Impact: Can't analyze which prompts lead to better user responses
- Solution: Add `ideal_state_prompts` table

‚ùå **Prompt Effectiveness**
- Problem: Can't correlate prompts ‚Üí user answers ‚Üí final quality
- Impact: Can't improve prompt quality over time
- Solution: Store prompts with timestamps

---

## üîß RECOMMENDED ACTIONS

### Immediate (High Priority)
1. ‚úÖ Create migration for `ideal_state_prompts` table
2. ‚úÖ Update `/api/viva/ideal-state` to save generated prompts
3. ‚úÖ Update frontend to optionally load cached prompts

### Short-Term (Medium Priority)  
4. Add `vision_assembly_snapshots` table for full input/output tracking
5. Store `harmonization_notes` in `vision_versions`
6. Add specific action types to token tracking enum

### Long-Term (Low Priority)
7. Create analytics views for fine-tuning data extraction
8. Build quality metrics dashboard
9. Implement A/B testing framework for prompt variations

---

## üíæ STORAGE OPTIMIZATION NOTES

**Current Storage Efficiency:** ‚úÖ Good
- Using JSONB for flexible structured data
- Proper foreign key relationships
- Timestamps for versioning
- Indexes on lookup fields

**V3 Improvements:** ‚úÖ Excellent
- `richness_metadata` enables density-aware analysis
- `blueprint_data` supports multiple loops
- `activation_message` captures completion state

**Missing:** Prompt generation artifacts for fine-tuning

---

## üìù NEXT STEPS

1. Review this audit with the team
2. Prioritize which gaps to fill first
3. Create migration for `ideal_state_prompts`
4. Update API to store prompts
5. Build data export tools for fine-tuning prep

---

**Document Owner:** AI Development Team  
**Last Updated:** November 11, 2025  
**Status:** Ready for Review

